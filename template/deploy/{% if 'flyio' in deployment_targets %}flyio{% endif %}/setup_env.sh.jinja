#!/usr/bin/env bash
set -euo pipefail

# Environment Setup Script for Fly.io
# This script helps set up environment variables and secrets for different environments

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
APP_NAME="{{ project_slug }}"
ENV_FILE=".env.fly"

# Functions
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_prompt() {
    echo -e "${BLUE}[INPUT]${NC} $1"
}

# Check if .env.fly exists
check_env_file() {
    if [ -f "$ENV_FILE" ]; then
        print_warning "Found existing $ENV_FILE"
        read -p "Do you want to load from existing file? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            source "$ENV_FILE"
            print_status "Loaded environment from $ENV_FILE"
            return 0
        fi
    fi
    return 1
}

# Create environment file
create_env_file() {
    print_status "Creating $ENV_FILE..."

    cat > "$ENV_FILE" << 'EOF'
# Fly.io Environment Configuration for {{ project_name }}
# Generated on $(date)

# App Configuration
export APP_NAME="{{ project_slug }}"
export ENVIRONMENT="production"
export FLY_REGION="iad"

# Django Settings
export DJANGO_SECRET_KEY=""
export DEBUG="False"
export ALLOWED_HOSTS=""

{% if use_sentry -%}
# Sentry Configuration
export SENTRY_DSN=""
{% endif %}

{% if media_storage == 'aws-s3' -%}
# AWS S3 Configuration
export AWS_ACCESS_KEY_ID=""
export AWS_SECRET_ACCESS_KEY=""
export AWS_STORAGE_BUCKET_NAME="{{ project_slug }}-media"
export AWS_S3_REGION_NAME="us-east-1"
{% endif %}

{% if use_stripe -%}
# Stripe Configuration
export STRIPE_PUBLISHABLE_KEY=""
export STRIPE_SECRET_KEY=""
export STRIPE_WEBHOOK_SECRET=""
{% endif %}

{% if use_sendgrid or use_mailgun -%}
# Email Configuration
{% if use_sendgrid -%}
export SENDGRID_API_KEY=""
{% endif %}
{% if use_mailgun -%}
export MAILGUN_API_KEY=""
export MAILGUN_DOMAIN=""
{% endif %}
export DEFAULT_FROM_EMAIL="noreply@{{ project_slug }}.fly.dev"
{% endif %}

# Custom Domain (optional)
export CUSTOM_DOMAIN=""
EOF

    print_status "$ENV_FILE created. Please edit it with your values."
}

# Interactive setup
interactive_setup() {
    print_status "Starting interactive environment setup..."
    echo ""

    # App name
    print_prompt "Enter app name (default: $APP_NAME):"
    read -r input_app_name
    APP_NAME="${input_app_name:-$APP_NAME}"

    # Environment
    print_prompt "Enter environment (production/staging) [default: production]:"
    read -r ENVIRONMENT
    ENVIRONMENT="${ENVIRONMENT:-production}"

    # Region
    print_prompt "Enter deployment region (iad/lhr/syd/sin/etc.) [default: iad]:"
    read -r FLY_REGION
    FLY_REGION="${FLY_REGION:-iad}"

    # Generate Django secret key
    print_prompt "Generate new Django secret key? (y/n) [default: y]:"
    read -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        DJANGO_SECRET_KEY=$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
        print_status "Generated new Django secret key"
    else
        print_prompt "Enter Django secret key:"
        read -r DJANGO_SECRET_KEY
    fi

    # Custom domain
    print_prompt "Enter custom domain (optional, press enter to skip):"
    read -r CUSTOM_DOMAIN

    if [ -n "$CUSTOM_DOMAIN" ]; then
        ALLOWED_HOSTS="$APP_NAME.fly.dev,$CUSTOM_DOMAIN,www.$CUSTOM_DOMAIN"
    else
        ALLOWED_HOSTS="$APP_NAME.fly.dev"
    fi

    {% if use_sentry -%}
    # Sentry
    print_prompt "Enter Sentry DSN (optional, press enter to skip):"
    read -r SENTRY_DSN
    {% endif %}

    {% if media_storage == 'aws-s3' -%}
    # AWS S3
    print_prompt "Configure AWS S3 for media storage? (y/n) [default: n]:"
    read -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_prompt "Enter AWS Access Key ID:"
        read -r AWS_ACCESS_KEY_ID

        print_prompt "Enter AWS Secret Access Key:"
        read -rs AWS_SECRET_ACCESS_KEY
        echo

        print_prompt "Enter S3 bucket name [default: $APP_NAME-media]:"
        read -r AWS_STORAGE_BUCKET_NAME
        AWS_STORAGE_BUCKET_NAME="${AWS_STORAGE_BUCKET_NAME:-$APP_NAME-media}"

        print_prompt "Enter AWS region [default: us-east-1]:"
        read -r AWS_S3_REGION_NAME
        AWS_S3_REGION_NAME="${AWS_S3_REGION_NAME:-us-east-1}"
    fi
    {% endif %}

    {% if use_stripe -%}
    # Stripe
    print_prompt "Configure Stripe? (y/n) [default: n]:"
    read -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_prompt "Enter Stripe Publishable Key:"
        read -r STRIPE_PUBLISHABLE_KEY

        print_prompt "Enter Stripe Secret Key:"
        read -rs STRIPE_SECRET_KEY
        echo

        print_prompt "Enter Stripe Webhook Secret (optional):"
        read -rs STRIPE_WEBHOOK_SECRET
        echo
    fi
    {% endif %}

    # Save to env file
    save_env_file
}

# Save environment to file
save_env_file() {
    print_status "Saving environment to $ENV_FILE..."

    cat > "$ENV_FILE" << EOF
# Fly.io Environment Configuration for {{ project_name }}
# Generated on $(date)

# App Configuration
export APP_NAME="$APP_NAME"
export ENVIRONMENT="$ENVIRONMENT"
export FLY_REGION="$FLY_REGION"

# Django Settings
export DJANGO_SECRET_KEY="$DJANGO_SECRET_KEY"
export DEBUG="False"
export ALLOWED_HOSTS="$ALLOWED_HOSTS"

{% if use_sentry -%}
# Sentry Configuration
export SENTRY_DSN="${SENTRY_DSN:-}"
{% endif %}

{% if media_storage == 'aws-s3' -%}
# AWS S3 Configuration
export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}"
export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}"
export AWS_STORAGE_BUCKET_NAME="${AWS_STORAGE_BUCKET_NAME:-}"
export AWS_S3_REGION_NAME="${AWS_S3_REGION_NAME:-}"
{% endif %}

{% if use_stripe -%}
# Stripe Configuration
export STRIPE_PUBLISHABLE_KEY="${STRIPE_PUBLISHABLE_KEY:-}"
export STRIPE_SECRET_KEY="${STRIPE_SECRET_KEY:-}"
export STRIPE_WEBHOOK_SECRET="${STRIPE_WEBHOOK_SECRET:-}"
{% endif %}

# Custom Domain
export CUSTOM_DOMAIN="${CUSTOM_DOMAIN:-}"
EOF

    chmod 600 "$ENV_FILE"
    print_status "Environment saved to $ENV_FILE"

    # Add to .gitignore
    if ! grep -q "$ENV_FILE" .gitignore 2>/dev/null; then
        echo "$ENV_FILE" >> .gitignore
        print_status "Added $ENV_FILE to .gitignore"
    fi
}

# Apply environment to Fly.io
apply_to_fly() {
    print_status "Applying environment to Fly.io app..."

    if [ ! -f "$ENV_FILE" ]; then
        print_error "$ENV_FILE not found. Run setup first."
    fi

    source "$ENV_FILE"

    # Check if app exists
    if ! fly apps list | grep -q "^$APP_NAME"; then
        print_error "App $APP_NAME does not exist. Run deploy.sh first."
    fi

    # Build secrets command
    local secrets_cmd="fly secrets set"
    secrets_cmd="$secrets_cmd DJANGO_SECRET_KEY='$DJANGO_SECRET_KEY'"
    secrets_cmd="$secrets_cmd DJANGO_SETTINGS_MODULE='config.settings.prod'"
    secrets_cmd="$secrets_cmd DEBUG='False'"
    secrets_cmd="$secrets_cmd ALLOWED_HOSTS='$ALLOWED_HOSTS'"

    {% if use_sentry -%}
    if [ -n "${SENTRY_DSN:-}" ]; then
        secrets_cmd="$secrets_cmd SENTRY_DSN='$SENTRY_DSN'"
    fi
    {% endif %}

    {% if media_storage == 'aws-s3' -%}
    if [ -n "${AWS_ACCESS_KEY_ID:-}" ]; then
        secrets_cmd="$secrets_cmd AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID'"
        secrets_cmd="$secrets_cmd AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY'"
        secrets_cmd="$secrets_cmd AWS_STORAGE_BUCKET_NAME='$AWS_STORAGE_BUCKET_NAME'"
        secrets_cmd="$secrets_cmd AWS_S3_REGION_NAME='$AWS_S3_REGION_NAME'"
    fi
    {% endif %}

    {% if use_stripe -%}
    if [ -n "${STRIPE_SECRET_KEY:-}" ]; then
        secrets_cmd="$secrets_cmd STRIPE_PUBLISHABLE_KEY='$STRIPE_PUBLISHABLE_KEY'"
        secrets_cmd="$secrets_cmd STRIPE_SECRET_KEY='$STRIPE_SECRET_KEY'"
        if [ -n "${STRIPE_WEBHOOK_SECRET:-}" ]; then
            secrets_cmd="$secrets_cmd STRIPE_WEBHOOK_SECRET='$STRIPE_WEBHOOK_SECRET'"
        fi
    fi
    {% endif %}

    secrets_cmd="$secrets_cmd --app $APP_NAME"

    # Apply secrets
    eval "$secrets_cmd"

    print_status "Secrets applied successfully"
}

# Show current configuration
show_config() {
    print_status "Current Fly.io configuration:"
    echo ""

    if [ -f "$ENV_FILE" ]; then
        print_status "Local environment ($ENV_FILE):"
        grep -E "^export " "$ENV_FILE" | sed 's/export /  /' | sed 's/=.*/=<set>/'
    else
        print_warning "No local environment file found"
    fi

    echo ""

    # Check if app exists
    if fly apps list | grep -q "^$APP_NAME"; then
        print_status "Remote secrets (Fly.io):"
        fly secrets list --app "$APP_NAME"
    else
        print_warning "App $APP_NAME does not exist on Fly.io"
    fi
}

# Main menu
main_menu() {
    echo "======================================"
    echo "Fly.io Environment Setup for {{ project_name }}"
    echo "======================================"
    echo ""
    echo "1. Interactive setup (create new environment)"
    echo "2. Load from existing $ENV_FILE"
    echo "3. Apply environment to Fly.io"
    echo "4. Show current configuration"
    echo "5. Create template env file"
    echo "6. Exit"
    echo ""
    print_prompt "Select option (1-6):"
    read -r option

    case $option in
        1)
            interactive_setup
            ;;
        2)
            if check_env_file; then
                print_status "Environment loaded"
            else
                print_error "No environment file found"
            fi
            ;;
        3)
            apply_to_fly
            ;;
        4)
            show_config
            ;;
        5)
            create_env_file
            ;;
        6)
            exit 0
            ;;
        *)
            print_error "Invalid option"
            ;;
    esac

    echo ""
    print_prompt "Press any key to continue..."
    read -n 1 -s
    echo ""
    main_menu
}

# Parse command line arguments
case "${1:-}" in
    setup)
        interactive_setup
        ;;
    apply)
        apply_to_fly
        ;;
    show)
        show_config
        ;;
    template)
        create_env_file
        ;;
    *)
        main_menu
        ;;
esac
